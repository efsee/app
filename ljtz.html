<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="black" />
<meta name="format-detection" content="telephone=no, email=no" />
<title>聚车金融</title>
<link href="css/css.css" rel="stylesheet" type="text/css" />
    <link href="css/mui.min.css" rel="stylesheet"/>

</head>
    <style type="text/css">
.header{
	width:100%;
	height:45px;
	background:#fff;
	text-align:center;
	font-size:0px;
	line-height:0px;
	position:fixed;
	z-index:999;
	left:0;
	top:0;
	b-webkit-box-sizing:border-box;
	-o-box-sizing:border-box;
	-ms-box-sizing:border-box;
	box-sizing:border-box;
	}
.header:after{
	width:100%;
	height:1px;
	position:absolute;
	left:0;
	bottom:0;
	background:#e6e5e5;
	content:"";
	font-size:0;
	}
header .mui-icon { color: #999; font-size: 14px; }
header .mui-title { color: #333; }
    	#main-box img { max-width: 100%;}
    	
.mui-loader { color: #999; line-height: 20px; font-size: 12px; padding-top: 50px; }

.mui-table-view {}
.mui-table-view:after,.mui-table-view:before { height: 0px; }
.mui-table-view-cell:after { left: 0px; }
.mui-table-view-cell { color: #666666; font-size: 12px; }

.mui-table-view-cell .dsp { right: 80px; position: absolute; }
.mui-table-view-cell i { right: 50px; top: 10px; position: absolute; }

.mui-card { border: 0; margin: 5px 0; }

.mui-input-group .mui-input-row { color: #666666; font-size: 12px; }
.mui-input-group:after,.mui-input-group:before { height: 0px; background: transparent; }
.mui-input-group .mui-input-row:after { left: 0; }
.mui-input-group .mui-input-row i { right: 50px; top: 10px; position: absolute; }
.mui-input-group .mui-input-row  .dsp { right: 80px; position: absolute; }
.moneyfont{ font-size:16px; font-weight:bold;color:#f13f3f;}

			.mui-popover {
				height: 300px;
			}
    </style>
<body>
<header class="mui-bar mui-bar-nav header">
	<a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left"></a>
	<a id="top_right_btn" class="mui-pull-right" style="display: none;"></a>
	<h1 id="title" class="mui-title">投资产品</h1>
</header>
		<!--侧滑菜单容器-->
		<div id="offCanvasWrapper" class="mui-off-canvas-wrap mui-draggable" style="margin-top: 40px;">
			<!--菜单部分-->
			<aside id="offCanvasSide" class="mui-off-canvas-right" style="width: 50%; background: #fff;">
				<div id="offCanvasSideScroll" class="mui-scroll-wrapper">
					<div class="mui-scroll" style="padding-bottom: 45px;">	
						<!--<button id="offCanvasHide" type="button" class="mui-btn mui-btn-block" style="padding: 5px 20px;">关闭</button>-->
						<div class="title mui-btn-danger" style="margin-bottom: 10px; line-height: 50px; text-align: center; color: #fff;">我的红包</div>
						<ul class="mui-table-view" id="hongbaolist">
						</ul>
					</div>
				</div>
			</aside>
			<div class="mui-inner-wrap">
				<div id="offCanvasContentScroll" class="mui-content mui-scroll-wrapper">
					<div class="mui-scroll">

<input type="hidden" name="borrow_nid" id="borrow_nid" value="0" />
<input type="hidden" name="borrow_apr" id="borrow_apr" value="0" />
<input type="hidden" name="borrow_period" id="borrow_period" value="0" />
<input type="hidden" name="borrow_style" id="borrow_style" value="" />
<div class="title-bt">可投资金额：<span class="c5" id="span_borrow_account">0</span>元</div>
<div id="borrow_account_wait" style=" display:none;"></div>
<div class="box plr10 btline">
<div class="wytz" style=" clear: both;  height:38px; padding: 0 2em 1em 5em;">
<span class="name">我要投资</span>
<span class="unit">元</span>
<div class="link"><input type="text" pattern="[0-9]*" id="money" name="money" value="" /> &nbsp;<button type="button" class="qetx-qetz" id="qetx">全额投资</button></div>

</div>
<div class="wytz-counts">预估收益 <span class="c5" id="span_borrow_sy">0.00</span> 元</div>
</div>

<div class="title-bt">支付信息</div>
		<div class="box plr10 btline">
		    <ul class="mui-table-view mui-table-view-striped mui-table-view-condensed">
		 
		        <li class="mui-table-view-cell">
		            <div class="mui-table">
		                <div class="mui-table-cell mui-col-xs-8">
		                	<span class="name">余额</span>
		                </div>
		                <div class="mui-table-cell mui-col-xs-4 mui-text-right">
		                    <span class="moneyfont" id="balance">0.00元</span>
		                </div>
		            </div>
		        </li>
		               <li class="mui-table-view-cell" id="hongbao-offCanvas">
		            <div class="mui-table">
		                <div class="mui-table-cell mui-col-xs-8">
		                	<span class="name">红包</span>
		                </div>
		                <div class="mui-table-cell mui-col-xs-4 mui-text-right">
		                    <span id="hongbao">未选择</span>
		                    <input type="hidden" name="hmoney" id="hmoney" value="0" />
		                </div>
		            </div>
		        </li>
		        <!--<li class="mui-table-view-cell">
		            <div class="mui-table">
		                <div class="mui-table-cell mui-col-xs-8">
		                	<span class="name">支付银行卡</span>
		                </div>
		                <div class="mui-table-cell mui-col-xs-4 mui-text-right">
		                    <span class="black">未选择</span>
		                </div>
		            </div>
		        </li>-->
		    </ul>
		</div>
<div class="exit-opn"><button class="btn" id="btn_submit">确认去支付</button></div>

					</div>
				</div>
				<!-- off-canvas backdrop -->
				<div class="mui-off-canvas-backdrop"></div>
			</div>
		</div>
</div>


<script type="text/html" id="tpl-hongbao-item">
		<li class="mui-table-view-cell">
			<a class="mui-navigate-right" data-value="0" data-id='0' data-money='0'>
				不使用红包
			</a>
		</li>
	{{each list as $item i}}
		<li class="mui-table-view-cell">
			<a class="mui-navigate-right" data-value="{{$item.id}}-{{$item.money}}" data-id='{{$item.id}}' data-money='{{$item.money}}'>
				{{$item.money}}元红包 <!--{{$item.tmoney}}-->
			</a>
		</li>
	{{/each}}
</script>
<script src="js/mui.min.js"></script>
<script src="js/jquery-1.11.2.min.js" type="text/javascript" charset="utf-8"></script>
<script src="js/api.js" type="text/javascript" charset="utf-8"></script>
<script src="js/template.js" type="text/javascript" charset="utf-8"></script>
<script src="js/template.function.js" type="text/javascript" charset="utf-8"></script>

<script type="text/javascript" charset="utf-8">
  	mui.init({swipeBack: false});
</script>
<script type="text/javascript">

</script>

<script type="text/javascript">
	mui.plusReady(function(){
		request = {'user_id':user.uid()};
		account.GetOne({'request':request},function(res){
//			console.log(JSON.stringify(res));
//			$('#total').html(res.total);			
			$('#balance').html(res.balance);
//			$('#await').html(res.await);
//			$('#income').html(res.income);
		})
			hbrequest = {};
			hbrequest = {'user_id': user.uid()};
			hbrequest.status = 1;
		user.GetHongbao({'request':hbrequest},function(res){
//			console.log(JSON.stringify(res));
				
			var html = template('tpl-hongbao-item',res);
			document.getElementById("hongbaolist").innerHTML = html;
//			$("#hongbaolist").html(html);
		})
		

		
		mui("#hongbaolist").on('tap','a', function(e){
			$("#hmoney").val(this.getAttribute('data-value'));
			$("#hongbao").html(this.innerText);
			offCanvasWrapper.offCanvas('close');
		})
		
		
		document.getElementById("hongbao-offCanvas").addEventListener("tap",function(e){
			e.stopPropagation();
			offCanvasWrapper.offCanvas('show');
			
		})

		
		document.getElementById("btn_submit").addEventListener('tap',function(e){
			var borrow_nid    = $("#borrow_nid").val();
			var borrow_apr    = $("#borrow_apr").val();
			var borrow_period = $("#borrow_period").val();
			var borrow_style  = $("#borrow_style").val();
			var money  = $("#money").val();
			var hmoney = $("#hmoney").val();
			request = {};
			request.borrow_nid = borrow_nid;
			request.borrow_apr = borrow_apr;
			request.borrow_period = borrow_period;
			request.borrow_style = borrow_style;
			request.money = money;
			request.user_id = user.uid();
			request.hmoney = hmoney;
			// 红包
			request.contents = '';
			
			if(money == ""){
				plus.nativeUI.alert('请输入投资金额！');
				return false;
			}
			
			plus.nativeUI.showWaiting();
			borrow.tender(request,function(res){
				console.log(JSON.stringify(res));
				plus.nativeUI.showWaiting();
				if(res.status == 1){
					//alert("投标成功");
						plus.nativeUI.closeWaiting();
						plus.nativeUI.alert( "投标成功!", function(){
							data = {'article_id': borrow_nid};
							mui.fire(plus.webview.currentWebview().opener(), "mui.view.show",data);
							try{
								mui.fire(plus.webview.currentWebview().opener().opener(), "reloadpage");
							}catch(e){}
							setTimeout(function(){
								mui.back();
							},150);
						}, "提示", "关闭" );
				}else{
					
					plus.nativeUI.closeWaiting();
					if(res.status == -2){
//						alert(res.msg + '-2');
						plus.nativeUI.alert(res.msg, function(){
//							mui.fire(plus.webview.currentWebview().opener(), "reload");
//							setTimeout(function(){
//								mui.back();
//							},150);
							mui.openWindow({'url':'w_recharge.html','id':'w_recharge.html', 'styles':{'top':'0px'},'show':{'autoShow':false},'waiting':{'autoShow':false}});

						}, "提示", "充值" );
					}else{
						plus.nativeUI.alert(res.msg);
					}
				}
			})

        
        
		});
		
		document.addEventListener('tap',function(event){
			if(document.activeElement == document.getElementById("money") && event.target.id != 'money'){
				$('#money').blur();
			}
		})
		
		
 			//侧滑容器父节点
			var offCanvasWrapper = mui('#offCanvasWrapper');
			 //主界面容器
			var offCanvasInner = offCanvasWrapper[0].querySelector('.mui-inner-wrap');
			 //菜单容器
			var offCanvasSide = document.getElementById("offCanvasSide");
			 //移动效果是否为整体移动
			var moveTogether = false;
			 //侧滑容器的class列表，增加.mui-slide-in即可实现菜单移动、主界面不动的效果；
			 //变换侧滑动画移动效果；
			 
//			document.getElementById('offCanvasShow').addEventListener('tap', function() {
//				offCanvasWrapper.offCanvas('show');
//			});
//			document.getElementById('offCanvasHide').addEventListener('tap', function() {
//				offCanvasWrapper.offCanvas('close');
//			});
			 //主界面和侧滑菜单界面均支持区域滚动；
			mui('#offCanvasSideScroll').scroll();
			mui('#offCanvasContentScroll').scroll();
			 //实现ios平台的侧滑关闭页面；
			if (mui.os.plus && mui.os.ios) {
				offCanvasWrapper[0].addEventListener('shown', function(e) { //菜单显示完成事件
					plus.webview.currentWebview().setStyle({
						'popGesture': 'none'
					});
				});
				offCanvasWrapper[0].addEventListener('hidden', function(e) { //菜单关闭完成事件
					plus.webview.currentWebview().setStyle({
						'popGesture': 'close'
					});
				});
			}
	})
	document.getElementById('qetx').addEventListener('tap',function(){
			
				
			var money = parseInt($("#balance").html());		
			var account_wait = parseInt($("#borrow_account_wait").html());
			var moneyb = parseInt(money/100);		
            var moneyd = moneyb*100;	
          
			if(money>100){
				if (money>account_wait){				
			        $("#money").val(account_wait);			      
				} else{
			       $("#money").val(moneyd);
			      
			      }
				 				
			}else{
				alert("    您的余额不足100，请充值！");
				
			}
			
			var borrow_nid    = $("#borrow_nid").val();
			var borrow_apr    = $("#borrow_apr").val();
			var borrow_period = $("#borrow_period").val();
			var borrow_style  = $("#borrow_style").val();
			var borrow_money  = $("#money").val();
			request = {};
			request.borrow_nid = borrow_nid;
			request.borrow_apr = borrow_apr;
			request.borrow_period = borrow_period;
			request.borrow_style = borrow_style;
			request.money = borrow_money;
			console.log(JSON.stringify(request));
			borrow.sy({'request':request},function(res){
				if(res) {
					$('#span_borrow_sy').html(res);
				}else{
					$('#span_borrow_sy').html("0.00");
				}
			})
			
		})
		document.addEventListener('mui.view.show',function(e){
//			console.log(JSON.stringify(e.detail));
			var id = e.detail.id;
			var borrow_account_wait = e.detail.borrow_account_wait;
			var account_wait = parseInt(borrow_account_wait);
			if(parseFloat(borrow_account_wait) >= 100){
				$('#span_borrow_account').html('100 ~ ' + borrow_account_wait);
			}else{
				$('#span_borrow_account').html(borrow_account_wait);
			}
			$('#borrow_account_wait').html(account_wait);
			$("#borrow_nid").val(e.detail.borrow_nid);
			$("#borrow_apr").val(e.detail.borrow_apr);
			$("#borrow_period").val(e.detail.borrow_period);
			$("#borrow_style").val(e.detail.borrow_style);

		},false);
		
		var back_old = mui.back;
		mui.back = function(){
			plus.webview.currentWebview().opener().evalJS("window.scrollTo(0,0);");
			back_old();
		}

$(function(){
    $('#money').keyup(function(){
	var borrow_nid    = $("#borrow_nid").val();
	var borrow_apr    = $("#borrow_apr").val();
	var borrow_period = $("#borrow_period").val();
	var borrow_style  = $("#borrow_style").val();
	var money  = $("#money").val();
	request = {};
	request.borrow_nid = borrow_nid;
	request.borrow_apr = borrow_apr;
	request.borrow_period = borrow_period;
	request.borrow_style = borrow_style;
	request.money = money;
	//console.log(JSON.stringify(request));
		borrow.sy({'request':request},function(res){
			if(res) {
				$('#span_borrow_sy').html(res);
			}else{
				$('#span_borrow_sy').html("0.00");
			}
		})
    });
    
	$("#money").blur(function(){
		if($("#hmoney").val() != 0){
			$("#hmoney").val('0');
			$("#hongbao").html("未选择");
		}
		var hbaomoney = $("#hongbaolist li");
		var moneyvalue = $("#money:text").val();
		if(!isNaN(moneyvalue)){
			hbaomoney.each(function(){
			 var str = $(this).find('a').attr('data-value');
			  strs=str.substr(str.indexOf('-')+1,9);
			 if( (moneyvalue)*(0.01) < 20 ){
			 	if ( (strs) > (moneyvalue)*(0.01) ){
					$(this).hide();
				}else{
					$(this).show();
				}
			 }else{
			 	if ( (strs) > (moneyvalue)*(0.005) ){
					$(this).hide();
				}else{
					$(this).show();
				}
			 }
			});
		}
	});
})
</script>
</body>
</html>