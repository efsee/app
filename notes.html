<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="black" />
<meta name="format-detection" content="telephone=no, email=no" />
<title>聚车金融</title>
     <link href="css/mui.min.css" rel="stylesheet"/>     
     <link href="css/iphone.css" rel="stylesheet"/>
     <script src="js/jquery-1.11.2.min.js"></script>
    <script src="js/mui.min.js"></script>
    <script src="js/api.js"></script>
    <script type="text/javascript" charset="utf-8">
      	mui.init();
    </script>
</head>
<body>
<div class="iphone-warp">
	<div class="mui-content">
			<!--<h5 class="mui-content-padded" style="margin: 15px 10px 15px 10px;"><a  style="display: block;" >全部</a></h5>
			<ul id="ss" class="mui-table-view">
				
				
			</ul>-->
	</div>
</div>
<script>
			mui.init();
			
			mui.plusReady(function(){
				
				request = {'user_id': user.uid()};
				user.GetllczList({'request':request},function(res){
					var myDate = new Date();
					if(res){
						$('.mui-content').html('');
						
						$(res).each(function(i,e){

							time=getLocalTime(e.create_at);
						 	tm=time.replace(/-/g,"/");
                            var date = new Date(tm);
                            
                            if(myDate.getMonth()==date.getMonth()){
                                yue="本月";
                            }else{
                            	yue=date.pattern("M")+"月";
                            }
                            
							if(myDate.getFullYear()==date.getFullYear()){
                                year='';
                            }else{
                            	year=date.getFullYear()+"年";
                            }
                            //console.log(date.getFullYear())

                            if (myDate.getYear()+myDate.getMonth()+myDate.getDate()==date.getYear()+date.getMonth()+date.getDate()){
                               var tm="今天";
                               var tm2=date.pattern("hh:mm");
                            }else{
                               var tm=date.pattern("E");
                               var tm2=date.pattern("MM-dd");
                            }

							str1='';
							if(parseInt(e.is_first)){
								str1='<span class="iphone-first">首冲</span>';
							}
							if(parseInt(e.status)==-1){
								str2='<div class="iphone-msdz">马上到账</div>';
							}
							else if(parseInt(e.status)==1){
								str2='<div class="iphone-msdz">充值成功</div>';
							}
							else{
								str2='<div class="iphone-czsb">充值失败</div>';
							}
							
							
							datamonth=date.getMonth();
							datayear=date.getFullYear();
							//console.log('.year-'+datayear+'.month-'+datamonth)
							if(!$('.mui-content').find('.year-'+datayear+'.month-'+datamonth).length){
								$('.mui-content').append(
									'<h5 class="mui-content-padded year-'+datayear+' month-'+datamonth+'" style="margin: 15px 10px 15px 10px;"><a  style="display: block;" >'+year+yue+'</a></h5>'+
									'<ul id="year-'+datayear+'-month-'+datamonth+'" class="mui-table-view">'+
									'</ul>'
								);
							}
							$('#year-'+datayear+'-month-'+datamonth).append(
							'<li class="mui-table-view-cell" data-order_no="'+e.order_no+'">'+
								'<div class="mui-slider-right mui-disabled">'+
									'<a  style="background-color: #f96268;" class="mui-btn mui-btn-red iphone-color">删除</a>'+
								'</div>'+
//							E hh:mm:ss
								'<div class="mui-slider-handle iphone-cont" data-order_no="'+e.order_no+'" data-account_no="'+e.account_no+'" data-sale_price="'+e.sale_price+'" data-face_price="'+e.face_price+'" data-time="'+time+'" data-status="'+e.status+'">'+						
									'<div class="iphone-date"><p>'+tm+'</p><p>'+tm2+'</p></div>'+
									'<div class="iphone-money">-'+e.sale_price+'元'+str1+'<p>充值'+e.face_price+'元 - '+e.account_no+'</p></div>'+  
									str2+					
								'</div>'+				
							'</li>'
							);
							//console.log(time)
							
						})
					}
					
				})
				var btnArray = ['取消', '确认'];
				$(document).on('tap', '.mui-btn', function(event) {
					var elem = this;
					var li = elem.parentNode.parentNode;
					var order_no = $(this).parents('li').attr('data-order_no');
					//console.log(order_no)
					mui.confirm('确认删除该条记录？', '', btnArray, function(e) {
						if (e.index == 1) {
							plus.nativeUI.showWaiting();
							request = {'order_no': order_no};
							//console.log(JSON.stringify(request));
							user.Deletellcz({'request':request},function(res){
								//console.log(JSON.stringify(res));
								if(res>0){
									
									mui.toast('删除成功');
									setTimeout(function(){
										li.parentNode.removeChild(li);
										plus.nativeUI.closeWaiting();
									},300);
								}
								else{
									mui.toast('删除失败');
									setTimeout(function(){
										plus.nativeUI.closeWaiting();
									},300);
								}
							})
						} else {
							setTimeout(function() {
								$.swipeoutClose(li);
							}, 0);
						}
					});
				});
				
				$(document).on('tap', '.iphone-cont', function(event) {
					var order_no = $(this).attr('data-order_no');
					var account_no = $(this).attr('data-account_no');
					var time = $(this).attr('data-time');
					var sale_price = $(this).attr('data-sale_price');
					var face_price = $(this).attr('data-face_price');
					var status = $(this).attr('data-status');
					//console.log(order_no);
					
					var	calling=plus.webview.create('notes_active.html','notes_active.html',{'popGesture':'close'});
				
					
					//触发详情页面的newsId事件
					plus.nativeUI.showWaiting();
					calling.addEventListener('loaded',function(){
						mui.fire(calling,'Getllcz',{
							order_no:order_no,
							account_no:account_no,
							time:time,
							sale_price:sale_price,
							face_price:face_price,
							status:status
						});
						
						
						setTimeout(function(){
							calling.show("slide-in-right",200);
							plus.nativeUI.closeWaiting();
						},300);
					});
				})
				
				
				/*request = {'user_id': user.uid()};
				user.UpdateCzlist({'request':request},function(res){
					console.log(JSON.stringify(res))
				})*/
				
			})
			
			
			function getLocalTime(nS) {     
		       return new Date(parseInt(nS) * 1000).toLocaleString().replace(/年|月/g, "-").replace(/日/g, "").replace('GMT+8', "");      
		    }
			
			function Deletellcz(request){
				user.Deletellcz({'request':request},function(res){
					console.log(JSON.stringify(res))
					
					
				})
			}
			
			/**      
			 * 对Date的扩展，将 Date 转化为指定格式的String      
			 * 月(M)、日(d)、12小时(h)、24小时(H)、分(m)、秒(s)、周(E)、季度(q) 可以用 1-2 个占位符      
			 * 年(y)可以用 1-4 个占位符，毫秒(S)只能用 1 个占位符(是 1-3 位的数字)      
			 * eg:      
			 * (new Date()).pattern("yyyy-MM-dd hh:mm:ss.S") ==> 2006-07-02 08:09:04.423      
			 * (new Date()).pattern("yyyy-MM-dd E HH:mm:ss") ==> 2009-03-10 二 20:09:04      
			 * (new Date()).pattern("yyyy-MM-dd EE hh:mm:ss") ==> 2009-03-10 周二 08:09:04      
			 * (new Date()).pattern("yyyy-MM-dd EEE hh:mm:ss") ==> 2009-03-10 星期二 08:09:04      
			 * (new Date()).pattern("yyyy-M-d h:m:s.S") ==> 2006-7-2 8:9:4.18      
			 */        
			Date.prototype.pattern=function(fmt) {         
			    var o = {         
			    "M+" : this.getMonth()+1, //月份         
			    "d+" : this.getDate(), //日         
			    "h+" : this.getHours()%24 == 0 ? 24 : this.getHours()%24, //小时         
			    "H+" : this.getHours(), //小时         
			    "m+" : this.getMinutes(), //分         
			    "s+" : this.getSeconds(), //秒         
			    "q+" : Math.floor((this.getMonth()+3)/3), //季度         
			    "S" : this.getMilliseconds() //毫秒         
			    };         
			    var week = {         
			    "0" : "周日",         
			    "1" : "周一",         
			    "2" : "周二",         
			    "3" : "周三",         
			    "4" : "周四",         
			    "5" : "周五",         
			    "6" : "周六"        
			    };         
			    if(/(y+)/.test(fmt)){         
			        fmt=fmt.replace(RegExp.$1, (this.getFullYear()+"").substr(4 - RegExp.$1.length));         
			    }         
			    if(/(E+)/.test(fmt)){         
			        fmt=fmt.replace(RegExp.$1, ((RegExp.$1.length>1) ? (RegExp.$1.length>2 ? "/u661f/u671f" : "/u5468") : "")+week[this.getDay()+""]);         
			    }         
			    for(var k in o){         
			        if(new RegExp("("+ k +")").test(fmt)){         
			            fmt = fmt.replace(RegExp.$1, (RegExp.$1.length==1) ? (o[k]) : (("00"+ o[k]).substr((""+ o[k]).length)));         
			        }         
			    }         
			    return fmt;         
			}
			
			
			
		</script>
</body>
</html>